<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>Using keyvi in pyspark or mrjob</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="keyvi-small.png"/></td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('md_doc_usage__using_pykeyvi_in__e_m_r.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Using keyvi in pyspark or mrjob </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Imagine you want to do some lookups in you map-reduce jobs like matching or extracting certain patterns - in fuzzy manner if you like - and your lookup table is huge. You could call a database or key value store remotely, but that kills performance and introduces a single point of failure in the otherwise distributed processing. With pykeyvi you can easily do that, given you are using a python based framework like mrjob or pyspark. Due to the shared memory model keyvi indexes are just loaded once in memory, independent on the number of mappers on one machine. It works even if keyvi files are bigger than the main memory, for the price of some IO of course. In the end all calls will be local and do not entail any networking.</p>
<h3>Bootstrapping keyvi</h3>
<p>All we need is to install keyvi at bootstraping time.</p>
<p>The precompiled packages support all supported versions of Amazons EMR. Therefore just install pykeyvi during bootstrap:</p>
<p>``` sudo pip install pykeyvi ```</p>
<h3>Using keyvi</h3>
<p>The rest is simply, get your keyvi files on the machines. You can download them during bootstrap from S3 or more convenient in pyspark, put them on hdfs:</p>
<p>``` sc = SparkContext.getOrCreate() sc.addFile(s3_filename) ```</p>
<p>Ensure you initialize the Dictionary e.g. in mapper_init (mrjob) or using a singleton pattern (pyspark) and not for every mapper call.</p>
<p>See this example loader for pyspark:</p>
<p>``` import pykeyvi</p>
<p>try: </p>
<h1>only works if in spark</h1>
<p>from pyspark import SparkFiles from pyspark import SparkContext</p>
<p>class Spark_KeyviLoader(object): </p>
<h1>this is a singleton</h1>
<p>_instance = None</p>
<p>def <b>init</b>(self): globals()[self.__class__.__name__] = self self.loaded_keyvi_dicts = {}</p>
<p>def <b>call</b>(self, *args, **kwargs): return self</p>
<p>def get(self, name): d = self.loaded_keyvi_dicts.get(name)</p>
<p>if d is None: hdfs_filename = SparkFiles.get(name) if hdfs_filename is None: raise Exception("Could not find dictionary with name {} in HDFS, Did you loaded it?".format(name))</p>
<p>if type(hdfs_filename): hdfs_filename = hdfs_filename.encode('utf-8')</p>
<p>try: d=pykeyvi.Dictionary(hdfs_filename) except Exception, e: raise Exception("Failed to load keyvi dictionary {}: {}".format(name, e.message))</p>
<p>self.loaded_keyvi_dicts[name] = d</p>
<p>return d</p>
<p>def load_into_spark(s3_filename): sc = SparkContext.getOrCreate() sc.addFile(s3_filename)</p>
<p>KeyviLoader = Spark_KeyviLoader</p>
<p>except: </p>
<h1>fallback for standalone use and testing</h1>
<p>import os</p>
<p>class Local_KeyviLoader(object): </p>
<h1>this is a singleton</h1>
<p>_instance = None</p>
<p>def <b>init</b>(self): globals()[self.__class__.__name__] = self self.loaded_keyvi_dicts = {}</p>
<p>def <b>call</b>(self, *args, **kwargs): return self</p>
<p>def get(self, name): d = self.loaded_keyvi_dicts.get(name)</p>
<p>if d is None: d = pykeyvi.Dictionary(os.path.join("my_keyvi_files_folder", name)) self.loaded_keyvi_dicts[name] = d</p>
<p>return d</p>
<p>KeyviLoader = Local_KeyviLoader</p>
<p>def get_keyvi_dictionary(name): return KeyviLoader().get(name)</p>
<p>``` </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Fri Nov 3 2017 15:07:06 by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 </li>
  </ul>
</div>
</body>
</html>
